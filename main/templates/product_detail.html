{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- Back Navigation -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="text-gray-700 hover:text-gray-900 font-semibold transition-colors">
        ‚Üê Kembali ke Daftar Produk
      </a>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="bg-white/50 backdrop-blur-lg rounded-2xl shadow-lg p-12 text-center">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Memuat detail produk...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="text-5xl mb-4">‚ö†Ô∏è</div>
      <h3 class="text-lg font-bold text-gray-800 mb-2">Gagal memuat detail produk</h3>
      <p class="text-gray-600">Silakan coba beberapa saat lagi.</p>
    </div>

    <!-- Product Detail -->
    <div id="product-detail" class="bg-white/50 backdrop-blur-lg rounded-2xl shadow-lg overflow-hidden hidden">

      <!-- Gambar -->
      <div id="product-image-container" class="w-full h-72 bg-gray-100 flex items-center justify-center overflow-hidden">
        <img id="product-image" src="" alt="" class="w-full h-full object-cover hidden">
        <p id="no-image" class="text-gray-400 text-lg">Tidak ada gambar</p>
      </div>

      <!-- Konten -->
      <div class="p-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4">
          <div>
            <h1 id="product-name" class="text-3xl font-extrabold text-gray-900 mb-2"></h1>
            <p id="product-brand" class="text-gray-700 italic mb-1"></p>
            <p id="product-category" class="text-sm text-gray-500 mb-4"></p>
          </div>
          <div class="text-right">
            <h2 id="product-price" class="text-2xl font-bold text-blue-700"></h2>
            <p id="product-stock" class="text-sm text-gray-500"></p>
          </div>
        </div>

        <hr class="my-5">

        <p id="product-description" class="text-gray-800 text-base leading-relaxed whitespace-pre-line"></p>

        <div class="mt-8 flex justify-between items-center">
          <p id="product-owner" class="text-sm text-gray-600 italic"></p>
          <div id="featured-badge" class="hidden px-3 py-1 rounded-full bg-yellow-200/60 text-yellow-800 text-xs font-medium">
            ‚≠ê Produk Unggulan
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- SCRIPT -->
<script>
const PRODUCT_ID = "{{ product.id }}";
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);

const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const productDetail = document.getElementById('product-detail');
const image = document.getElementById('product-image');
const noImage = document.getElementById('no-image');
const imageContainer = document.getElementById('product-image-container');
const nameEl = document.getElementById('product-name');
const brandEl = document.getElementById('product-brand');
const categoryEl = document.getElementById('product-category');
const priceEl = document.getElementById('product-price');
const stockEl = document.getElementById('product-stock');
const descEl = document.getElementById('product-description');
const ownerEl = document.getElementById('product-owner');
const featuredBadge = document.getElementById('featured-badge');

function showState(state) {
  loadingState.classList.toggle('hidden', state !== 'loading');
  errorState.classList.toggle('hidden', state !== 'error');
  productDetail.classList.toggle('hidden', state !== 'ready');
}

function renderProduct(product) {
  nameEl.textContent = product.name;
  brandEl.textContent = product.brand || '-';
  categoryEl.textContent = `Kategori: ${product.category}`;
  priceEl.textContent = `Rp ${product.price.toLocaleString()}`;
  stockEl.textContent = `Stok: ${product.stock}`;
  descEl.textContent = product.description || 'Tidak ada deskripsi.';
  ownerEl.textContent = `üë§ Dibuat oleh: ${product.user_username || 'Anonim'}`;

  if (product.thumbnail) {
    image.src = product.thumbnail;
    image.alt = product.name;
    image.classList.remove('hidden');
    noImage.classList.add('hidden');
  } else {
    image.classList.add('hidden');
    noImage.classList.remove('hidden');
  }

  featuredBadge.classList.toggle('hidden', !product.is_featured);
}

async function loadProductDetail() {
  try {
    showState('loading');
    const res = await fetch(PRODUCT_DETAIL_ENDPOINT, { headers: {'Accept': 'application/json'} });
    if (!res.ok) throw new Error('Failed to fetch');
    const data = await res.json();
    renderProduct(data);
    showState('ready');
  } catch (err) {
    console.error(err);
    showState('error');
    showToast("Gagal Memuat Produk", "Terjadi kesalahan saat mengambil data produk.", "error");
  }
}

loadProductDetail();
</script>
{% endblock content %}
